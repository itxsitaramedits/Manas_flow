<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Challenges - Manas Flow</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #ff4d4d, #ff9933, #ffd633, #66cc66);
      min-height: 100vh;
      padding: 20px;
      padding-bottom: 100px;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    .glass-card {
      background: rgba(255, 255, 255, 0.92);
      backdrop-filter: blur(10px);
      border-radius: 25px;
      padding: 30px;
      margin: 20px 0;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
      animation: fadeIn 0.6s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 2.5em;
      background: linear-gradient(135deg, #ff4d4d, #ff9933);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: 700;
    }

    .challenge-card {
      background: rgba(255, 255, 255, 0.95);
      padding: 25px;
      border-radius: 20px;
      margin: 20px 0;
      border-left: 6px solid #ff9933;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      transition: all 0.3s;
    }

    .challenge-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(255, 153, 51, 0.3);
      border-left-width: 10px;
    }

    .challenge-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      cursor: pointer;
    }

    .challenge-name {
      font-size: 1.6em;
      font-weight: 700;
      background: linear-gradient(135deg, #ff9933, #ffd633);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .challenge-days {
      background: linear-gradient(135deg, #ff9933, #ffd633);
      color: #333;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.9em;
    }

    .challenge-desc {
      color: #555;
      line-height: 1.6;
      margin-bottom: 15px;
    }

    .expand-icon {
      font-size: 1.5em;
      transition: transform 0.3s;
    }

    .expand-icon.expanded {
      transform: rotate(180deg);
    }

    .challenge-content {
      display: none;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 2px solid rgba(255, 153, 51, 0.2);
    }

    .challenge-content.expanded {
      display: block;
    }

    .day-section {
      background: linear-gradient(135deg, rgba(255, 153, 51, 0.05), rgba(255, 215, 51, 0.1));
      padding: 20px;
      border-radius: 15px;
      margin: 15px 0;
      border-left: 4px solid #ffd633;
    }

    .day-title {
      font-size: 1.3em;
      font-weight: 700;
      color: #ff9933;
      margin-bottom: 15px;
    }

    .task-item {
      display: flex;
      align-items: flex-start;
      gap: 15px;
      padding: 15px;
      background: white;
      border-radius: 12px;
      margin: 10px 0;
      transition: all 0.3s;
      border: 2px solid transparent;
    }

    .task-item:hover {
      border-color: #ffd633;
      box-shadow: 0 5px 15px rgba(255, 215, 51, 0.3);
    }

    .task-checkbox {
      width: 24px;
      height: 24px;
      cursor: pointer;
      accent-color: #ff9933;
    }

    .task-content {
      flex: 1;
    }

    .task-name {
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
      font-size: 1.05em;
    }

    .task-desc {
      color: #666;
      font-size: 0.95em;
      line-height: 1.5;
    }

    .task-item.completed {
      opacity: 0.6;
    }

    .task-item.completed .task-name {
      text-decoration: line-through;
    }

    .progress-bar {
      width: 100%;
      height: 28px;
      background: rgba(255, 153, 51, 0.2);
      border-radius: 15px;
      overflow: hidden;
      margin: 20px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #ff9933, #ffd633, #66cc66);
      transition: width 0.5s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #333;
      font-weight: 700;
      font-size: 0.9em;
    }

    .reward-badge {
      display: inline-block;
      background: linear-gradient(135deg, #66cc66, #ffd633);
      color: #333;
      padding: 10px 20px;
      border-radius: 20px;
      font-weight: 700;
      margin-top: 10px;
      box-shadow: 0 5px 15px rgba(102, 204, 102, 0.3);
    }

    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      display: flex;
      justify-content: space-around;
      padding: 15px 0;
      box-shadow: 0 -5px 25px rgba(0, 0, 0, 0.15);
      z-index: 1000;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
      color: #666;
      text-decoration: none;
      font-size: 0.85em;
      transition: all 0.3s;
      padding: 5px 15px;
      border-radius: 12px;
    }

    .nav-item:hover, .nav-item.active {
      background: rgba(255, 153, 51, 0.1);
      color: #ff9933;
    }

    .nav-symbol {
      font-size: 1.8em;
    }

    @media (max-width: 768px) {
      .challenge-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>⚙ Flow Challenges</h1>
    </div>

    <div id="challengesContainer"></div>
  </div>

  <div class="bottom-nav">
    <a href="tools.html" class="nav-item">
      <div class="nav-symbol">✦</div>
      <div>Tools</div>
    </a>
    <a href="challenges.html" class="nav-item active">
      <div class="nav-symbol">⚙</div>
      <div>Challenges</div>
    </a>
    <a href="about.html" class="nav-item">
      <div class="nav-symbol">☀</div>
      <div>About</div>
    </a>
    <a href="index.html" class="nav-item">
      <div class="nav-symbol">❖</div>
      <div>Home</div>
    </a>
    <a href="index.html" class="nav-item">
      <div class="nav-symbol">⤴</div>
      <div>Logout</div>
    </a>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
    import { getDatabase, ref, set, get, onValue, update } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyB-8F4Ja6iWJNCli6OqnyuvRScXI5MHVkk",
      authDomain: "useful-life.firebaseapp.com",
      databaseURL: "https://useful-life-default-rtdb.firebaseio.com",
      projectId: "useful-life",
      storageBucket: "useful-life.firebasestorage.app",
      messagingSenderId: "598259358855",
      appId: "1:598259358855:web:080fb89d7bda4788802c22"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let currentUser = null;
    let userProgress = {};

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = 'index.html';
        return;
      }
      currentUser = user;
      await loadUserProgress();
      loadChallenges();
    });

    async function loadUserProgress() {
      const progressRef = ref(db, `users/${currentUser.uid}/challenges`);
      const snapshot = await get(progressRef);
      userProgress = snapshot.exists() ? snapshot.val() : {};
    }

    function loadChallenges() {
      const challengesRef = ref(db, 'admin/challenges');
      onValue(challengesRef, (snapshot) => {
        const container = document.getElementById('challengesContainer');
        container.innerHTML = '';

        if (!snapshot.exists()) {
          container.innerHTML = '<div class="glass-card"><p style="text-align:center;color:#666;">No challenges available yet</p></div>';
          return;
        }

        const challenges = snapshot.val();
        Object.entries(challenges).forEach(([id, challenge]) => {
          const card = createChallengeCard(id, challenge);
          container.appendChild(card);
        });
      });
    }

    function createChallengeCard(id, challenge) {
      const card = document.createElement('div');
      card.className = 'challenge-card';

      const totalTasks = calculateTotalTasks(challenge.tasks);
      const completedTasks = calculateCompletedTasks(id, challenge.tasks);
      const progressPercent = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
      const isCompleted = progressPercent === 100;

      card.innerHTML = `
        <div class="challenge-header" onclick="toggleChallenge('${id}')">
          <div>
            <div class="challenge-name">${escapeHtml(challenge.name)}</div>
            <div class="challenge-desc">${escapeHtml(challenge.description)}</div>
          </div>
          <div style="text-align:right;">
            <div class="challenge-days">${challenge.totalDays} Days</div>
            <span class="expand-icon" id="icon-${id}">▼</span>
          </div>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" style="width: ${progressPercent}%">${progressPercent}%</div>
        </div>
        ${isCompleted ? '<div class="reward-badge">✦ +10 Flow Points Earned!</div>' : ''}
        <div class="challenge-content" id="content-${id}">
          ${renderDays(id, challenge.tasks)}
        </div>
      `;

      return card;
    }

    function renderDays(challengeId, tasks) {
      if (!tasks) return '<p>No tasks available</p>';

      let html = '';
      Object.entries(tasks).sort((a, b) => parseInt(a[0]) - parseInt(b[0])).forEach(([day, dayData]) => {
        html += `
          <div class="day-section">
            <div class="day-title">Day ${day}</div>
            ${renderTasks(challengeId, day, dayData.items)}
          </div>
        `;
      });

      return html;
    }

    function renderTasks(challengeId, day, items) {
      if (!items) return '<p>No tasks for this day</p>';

      let html = '';
      Object.entries(items).forEach(([taskId, task]) => {
        const isCompleted = userProgress[challengeId]?.[day]?.[taskId] === true;
        html += `
          <div class="task-item ${isCompleted ? 'completed' : ''}">
            <input 
              type="checkbox" 
              class="task-checkbox" 
              ${isCompleted ? 'checked' : ''}
              onchange="toggleTask('${challengeId}', '${day}', '${taskId}')"
            >
            <div class="task-content">
              <div class="task-name">${escapeHtml(task.name)}</div>
              <div class="task-desc">${escapeHtml(task.description)}</div>
            </div>
          </div>
        `;
      });

      return html;
    }

    window.toggleChallenge = (id) => {
      const content = document.getElementById(`content-${id}`);
      const icon = document.getElementById(`icon-${id}`);
      
      content.classList.toggle('expanded');
      icon.classList.toggle('expanded');
    };

    window.toggleTask = async (challengeId, day, taskId) => {
      if (!userProgress[challengeId]) userProgress[challengeId] = {};
      if (!userProgress[challengeId][day]) userProgress[challengeId][day] = {};
      
      userProgress[challengeId][day][taskId] = !userProgress[challengeId][day][taskId];

      await set(ref(db, `users/${currentUser.uid}/challenges`), userProgress);

      // Check if challenge completed, add reward
      const challengeRef = ref(db, `admin/challenges/${challengeId}`);
      const snapshot = await get(challengeRef);
      if (snapshot.exists()) {
        const challenge = snapshot.val();
        const totalTasks = calculateTotalTasks(challenge.tasks);
        const completedTasks = calculateCompletedTasks(challengeId, challenge.tasks);
        
        if (completedTasks === totalTasks) {
          const userRef = ref(db, `users/${currentUser.uid}`);
          const userSnapshot = await get(userRef);
          if (userSnapshot.exists()) {
            const userData = userSnapshot.val();
            await update(userRef, {
              rewards: (userData.rewards || 0) + 10
            });
          }
        }
      }
    };

    function calculateTotalTasks(tasks) {
      if (!tasks) return 0;
      let total = 0;
      Object.values(tasks).forEach(day => {
        if (day.items) total += Object.keys(day.items).length;
      });
      return total;
    }

    function calculateCompletedTasks(challengeId, tasks) {
      if (!userProgress[challengeId] || !tasks) return 0;
      let completed = 0;
      Object.entries(tasks).forEach(([day, dayData]) => {
        if (dayData.items && userProgress[challengeId][day]) {
          Object.keys(dayData.items).forEach(taskId => {
            if (userProgress[challengeId][day][taskId] === true) completed++;
          });
        }
      });
      return completed;
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>